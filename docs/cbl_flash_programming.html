<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5X74N6G74T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-5X74N6G74T');
</script>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CANopen (FD) Bootloader Protocol Stack | Flash Programming</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
   DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mc-awesome.css" rel="stylesheet" type="text/css"/>
<link href="mc-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="mc-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectbrief">CANopen (FD) Bootloader Documentation</div>
   <div id="projectnumber">Version 4.08.00</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('cbl_flash_programming.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Flash Programming </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_pages_cbl_start_cbl_flash_programming"></a></p>
<p>Access to the Flash memory is done via three callback functions. They are called when data is written to the CANopen objects 1F50<sub>h</sub> and 1F51<sub>h</sub> by a CANopen Program Download Tool.</p>
<div class="function" style="width:90%"> <table class="function">
<tr>
<td class="entry" style="width:25%"><a class="el" href="cbl__mgr_8h.html#a4beb62dc5018b06f558366cd4f418608">CblMgrBufferStore()</a> </td><td class="desc"><p class="starttd">Store program / data in flash memory, callback function in <code>cbl_user.c</code> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td class="entry" style="width:25%"><a class="el" href="cbl__mgr_8h.html#ab9c927845b9e63bda4e267f311b54460">CblMgrFlashDelete()</a> </td><td class="desc"><p class="starttd">Delete program / data in flash memory, callback function in <code>cbl_user.c</code> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td class="entry" style="width:25%"><a class="el" href="cbl__mgr_8h.html#a5274f1da62f4601141b4fa924383aa5c">CblMgrFlashFinalize()</a> </td><td class="desc"><p class="starttd">Finalize program / data in flash memory, callback function in <code>cbl_user.c</code> </p>
<p class="endtd"></p>
</td></tr>
</table>
</div><p>The next figure gives an overview of the involved CANopen objects during program download.</p>
<div class="dyncontent"> <img src="bootloader_program_download.png" alt="" class="inline" title="Program download"/>     </div><p>The following global variables are used inside the callback functions.</p>
<div class="function" style="width:90%"> <table class="function">
<tr class="head">
<td class="desc" style="width:25%">Variable </td><td class="desc" style="width:20%">Access </td><td class="desc"><p class="starttd">Description </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td class="entry" style="width:25%"><a class="el" href="cbl__objs_8h.html#ab0a69221ce606d106cacb872def6d0df" title="Program software identification - index 1F56:0xh">aulIdx1F56_SoftIdentG</a>[] </td><td class="desc" style="width:20%">write </td><td class="desc"><p class="starttd">CRC value of program, CANopen access via 1F56<sub>h</sub> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td class="entry" style="width:25%"><a class="el" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2" title="Flash status identification - index 1F57:0xh">aulIdx1F57_FlashStatusG</a>[] </td><td class="desc" style="width:20%">write </td><td class="desc"><p class="starttd">Flash status, CANopen access via 1F57<sub>h</sub> </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td class="entry" style="width:25%">ubCblMgrBufferStoreG[] </td><td class="desc" style="width:20%">read/write </td><td class="desc">Write value 0 to mark the end of a flash operation  </td></tr>
</table>
</div><h1>Erase Flash Memory</h1>
<p>The function <a class="el" href="cbl__mgr_8h.html#ab9c927845b9e63bda4e267f311b54460">CblMgrFlashDelete()</a> is called by the CANopen (FD) Bootloader upon reception of a program erase command in object 1F51<sub>h</sub>. The following code has to be adopted to the target system.</p>
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="cbl__mgr_8h.html#ab9c927845b9e63bda4e267f311b54460">CblMgrFlashDelete</a>(uint8_t ubProgNumV)</div>
<div class="line">{</div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// Unlock flash memory</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <a class="code hl_function" href="mc__flash_8h.html#ab94a4a6ee80426501c5b5ab3ac4489e4">McFlashUnlock</a>();</div>
<div class="line"> </div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// Set status in object 1F57h: flash operation in progress</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] = <a class="code hl_enumvalue" href="cbl__mgr_8h.html#ae90447d48ead6e3826aa66905b52e4e0addb624cb27e10c8a9dad093ff3050848">eCBL_FLASH_STATUS_PROGRESS</a>;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// Erase flash and set status in object 1F57h</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <span class="keywordflow">if</span> (<a class="code hl_function" href="mc__flash_8h.html#acb4c366200ae6d46cf8dc460b9acee24">McFlashErase</a>(<a class="code hl_define" href="cbl__conf_8h.html#a01ecd75e4d11f5e4a10233a5d211bb42">CBL_APP_START_ADDR</a>, <a class="code hl_function" href="mc__iap_8h.html#a8c6d1fa8f0cf30262b5e33341c65f271">McIapAppSizeLimit</a>()) != <a class="code hl_enumvalue" href="mc__flash_8h.html#a8fd6cf62b670afcecffaad6893da5eafa359ca710fb31ae3fea3df21d39dc85ad">eFLASH_ERR_OK</a>)</div>
<div class="line">   {</div>
<div class="line">      <a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] = <a class="code hl_enumvalue" href="cbl__mgr_8h.html#a9636a1b12abd1c8a0ed8b0e9e5455f17a8a60b73c539aae2a98a9ba4f2198dfe1">eCBL_FLASH_FAIL_WRITE_ERROR</a> &lt;&lt; 1;</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">   {</div>
<div class="line">      <a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] = <a class="code hl_enumvalue" href="cbl__mgr_8h.html#a9636a1b12abd1c8a0ed8b0e9e5455f17a3f473604df18dd62aa9a2bc059321113">eCBL_FLASH_FAIL_NO_PROGRAM</a> &lt;&lt; 1;</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// lock flash</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <a class="code hl_function" href="mc__flash_8h.html#a13a481e202b71b890ccbff63a5e29343">McFlashLock</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// clear software identification</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <a class="code hl_variable" href="cbl__objs_8h.html#ab0a69221ce606d106cacb872def6d0df">aulIdx1F56_SoftIdentG</a>[ubProgNumV] = 0x00000000;</div>
<div class="line">   </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="ttc" id="acbl__conf_8h_html_a01ecd75e4d11f5e4a10233a5d211bb42"><div class="ttname"><a href="cbl__conf_8h.html#a01ecd75e4d11f5e4a10233a5d211bb42">CBL_APP_START_ADDR</a></div><div class="ttdeci">#define CBL_APP_START_ADDR</div><div class="ttdef"><b>Definition:</b> cbl_conf.h:291</div></div>
<div class="ttc" id="acbl__mgr_8h_html_a9636a1b12abd1c8a0ed8b0e9e5455f17a3f473604df18dd62aa9a2bc059321113"><div class="ttname"><a href="cbl__mgr_8h.html#a9636a1b12abd1c8a0ed8b0e9e5455f17a3f473604df18dd62aa9a2bc059321113">eCBL_FLASH_FAIL_NO_PROGRAM</a></div><div class="ttdeci">@ eCBL_FLASH_FAIL_NO_PROGRAM</div><div class="ttdef"><b>Definition:</b> cbl_mgr.h:94</div></div>
<div class="ttc" id="acbl__mgr_8h_html_a9636a1b12abd1c8a0ed8b0e9e5455f17a8a60b73c539aae2a98a9ba4f2198dfe1"><div class="ttname"><a href="cbl__mgr_8h.html#a9636a1b12abd1c8a0ed8b0e9e5455f17a8a60b73c539aae2a98a9ba4f2198dfe1">eCBL_FLASH_FAIL_WRITE_ERROR</a></div><div class="ttdeci">@ eCBL_FLASH_FAIL_WRITE_ERROR</div><div class="ttdef"><b>Definition:</b> cbl_mgr.h:106</div></div>
<div class="ttc" id="acbl__mgr_8h_html_ab9c927845b9e63bda4e267f311b54460"><div class="ttname"><a href="cbl__mgr_8h.html#ab9c927845b9e63bda4e267f311b54460">CblMgrFlashDelete</a></div><div class="ttdeci">void CblMgrFlashDelete(uint8_t ubProgNumV)</div></div>
<div class="ttc" id="acbl__mgr_8h_html_ae90447d48ead6e3826aa66905b52e4e0addb624cb27e10c8a9dad093ff3050848"><div class="ttname"><a href="cbl__mgr_8h.html#ae90447d48ead6e3826aa66905b52e4e0addb624cb27e10c8a9dad093ff3050848">eCBL_FLASH_STATUS_PROGRESS</a></div><div class="ttdeci">@ eCBL_FLASH_STATUS_PROGRESS</div><div class="ttdef"><b>Definition:</b> cbl_mgr.h:78</div></div>
<div class="ttc" id="acbl__objs_8h_html_a321cba23fceb635734f97a3f4bce73e2"><div class="ttname"><a href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a></div><div class="ttdeci">uint32_t aulIdx1F57_FlashStatusG[]</div><div class="ttdoc">Flash status identification - index 1F57:0xh</div></div>
<div class="ttc" id="acbl__objs_8h_html_ab0a69221ce606d106cacb872def6d0df"><div class="ttname"><a href="cbl__objs_8h.html#ab0a69221ce606d106cacb872def6d0df">aulIdx1F56_SoftIdentG</a></div><div class="ttdeci">uint32_t aulIdx1F56_SoftIdentG[]</div><div class="ttdoc">Program software identification - index 1F56:0xh</div></div>
<div class="ttc" id="amc__flash_8h_html_a13a481e202b71b890ccbff63a5e29343"><div class="ttname"><a href="mc__flash_8h.html#a13a481e202b71b890ccbff63a5e29343">McFlashLock</a></div><div class="ttdeci">Status_tv McFlashLock(void)</div><div class="ttdoc">Lock the Flash memory controller.</div></div>
<div class="ttc" id="amc__flash_8h_html_a8fd6cf62b670afcecffaad6893da5eafa359ca710fb31ae3fea3df21d39dc85ad"><div class="ttname"><a href="mc__flash_8h.html#a8fd6cf62b670afcecffaad6893da5eafa359ca710fb31ae3fea3df21d39dc85ad">eFLASH_ERR_OK</a></div><div class="ttdeci">@ eFLASH_ERR_OK</div><div class="ttdef"><b>Definition:</b> mc_flash.h:77</div></div>
<div class="ttc" id="amc__flash_8h_html_ab94a4a6ee80426501c5b5ab3ac4489e4"><div class="ttname"><a href="mc__flash_8h.html#ab94a4a6ee80426501c5b5ab3ac4489e4">McFlashUnlock</a></div><div class="ttdeci">Status_tv McFlashUnlock(void)</div><div class="ttdoc">Unlock the Flash memory controller.</div></div>
<div class="ttc" id="amc__flash_8h_html_acb4c366200ae6d46cf8dc460b9acee24"><div class="ttname"><a href="mc__flash_8h.html#acb4c366200ae6d46cf8dc460b9acee24">McFlashErase</a></div><div class="ttdeci">Status_tv McFlashErase(uint32_t ulFlashAddrV, uint32_t ulSizeV)</div><div class="ttdoc">Erase page of selected address.</div></div>
<div class="ttc" id="amc__iap_8h_html_a8c6d1fa8f0cf30262b5e33341c65f271"><div class="ttname"><a href="mc__iap_8h.html#a8c6d1fa8f0cf30262b5e33341c65f271">McIapAppSizeLimit</a></div><div class="ttdeci">uint32_t McIapAppSizeLimit(void)</div></div>
</div><!-- fragment --><p> The following flowchart shows the interaction upon writing the Erase command or a Manufacturer-specific command to index 1F51<sub>h</sub> inside the object dictionary.</p>
<div class="dyncontent"> <img src="bootloader_erase_flash.png" alt="" class="inline" title="Program erase"/>     </div><h1>Store Data to Flash Memory</h1>
<p>The function <a class="el" href="cbl__mgr_8h.html#a4beb62dc5018b06f558366cd4f418608">CblMgrBufferStore()</a> is called by the CANopen Bootloader after a certain amount of data has been copied to the internal RAM of the target system by the CANopen Download Tool. The following code has to be adopted to the target system.</p>
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="cbl__mgr_8h.html#a4beb62dc5018b06f558366cd4f418608">CblMgrBufferStore</a>(uint8_t ubProgNumV, uint8_t * pubBufferV, uint16_t uwSizeV)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">static</span> uint32_t   ulAddrStartS = (<a class="code hl_define" href="cbl__conf_8h.html#a01ecd75e4d11f5e4a10233a5d211bb42">CBL_APP_START_ADDR</a>);</div>
<div class="line">   <span class="keyword">static</span> uint32_t   ulBlockNumS = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// This function is called by the CANopen bootloader when new data shall be stored inside the Flash</span></div>
<div class="line">   <span class="comment">// memory. The global variable &#39;ubCblMgrBufferStoreG&#39; is &gt; 0 when data needs to be stored. This</span></div>
<div class="line">   <span class="comment">// function has to set the value back to 0 when data store is done.</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <span class="keywordflow">if</span> (ubCblMgrBufferStoreG &gt; 0)</div>
<div class="line">   {</div>
<div class="line">      <span class="comment">//-------------------------------------------------------------------------------------------</span></div>
<div class="line">      <span class="comment">// Test if flash is empty: we initialize the start address then and set the block counter </span></div>
<div class="line">      <span class="comment">// to 0.</span></div>
<div class="line">      <span class="comment">//</span></div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] == (<a class="code hl_enumvalue" href="cbl__mgr_8h.html#a9636a1b12abd1c8a0ed8b0e9e5455f17a3f473604df18dd62aa9a2bc059321113">eCBL_FLASH_FAIL_NO_PROGRAM</a> &lt;&lt; 1) )</div>
<div class="line">      {</div>
<div class="line">         ulAddrStartS = (<a class="code hl_define" href="cbl__conf_8h.html#a01ecd75e4d11f5e4a10233a5d211bb42">CBL_APP_START_ADDR</a>);</div>
<div class="line">         <a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] = <a class="code hl_enumvalue" href="cbl__mgr_8h.html#ae90447d48ead6e3826aa66905b52e4e0addb624cb27e10c8a9dad093ff3050848">eCBL_FLASH_STATUS_PROGRESS</a>;</div>
<div class="line">         ulBlockNumS = 0;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">//-------------------------------------------------------------------------------------------</span></div>
<div class="line">      <span class="comment">// At this point the flash status shall be eCBL_FLASH_STATUS_PROGRESS, otherwise something</span></div>
<div class="line">      <span class="comment">// went really wrong.</span></div>
<div class="line">      <span class="comment">//</span></div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] == <a class="code hl_enumvalue" href="cbl__mgr_8h.html#ae90447d48ead6e3826aa66905b52e4e0addb624cb27e10c8a9dad093ff3050848">eCBL_FLASH_STATUS_PROGRESS</a>)</div>
<div class="line">      {</div>
<div class="line">         <span class="comment">//-----------------------------------------------------------------------------------</span></div>
<div class="line">         <span class="comment">// unlock flash</span></div>
<div class="line">         <span class="comment">//</span></div>
<div class="line">         <a class="code hl_function" href="mc__flash_8h.html#ab94a4a6ee80426501c5b5ab3ac4489e4">McFlashUnlock</a>();</div>
<div class="line">         ulBlockNumS++;</div>
<div class="line"> </div>
<div class="line">         <span class="comment">//-----------------------------------------------------------------------------------</span></div>
<div class="line">         <span class="comment">// Write data from SRAM buffer to flash, the size must be an even value</span></div>
<div class="line">         <span class="comment">//</span></div>
<div class="line">         <span class="keywordflow">if</span> (uwSizeV % 2)</div>
<div class="line">         {</div>
<div class="line">            uwSizeV++;</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">if</span> (<a class="code hl_function" href="mc__flash_8h.html#a9e97798abc12ae92c41839f24064d103">McFlashWrite</a>(ulAddrStartS, pubBufferV, uwSizeV) != <a class="code hl_enumvalue" href="mc__flash_8h.html#a8fd6cf62b670afcecffaad6893da5eafa359ca710fb31ae3fea3df21d39dc85ad">eFLASH_ERR_OK</a>)</div>
<div class="line">         {</div>
<div class="line">            <a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] = <a class="code hl_enumvalue" href="cbl__mgr_8h.html#a9636a1b12abd1c8a0ed8b0e9e5455f17a8a60b73c539aae2a98a9ba4f2198dfe1">eCBL_FLASH_FAIL_WRITE_ERROR</a> &lt;&lt; 1;</div>
<div class="line">         }</div>
<div class="line"> </div>
<div class="line">         <span class="comment">//-----------------------------------------------------------------------------------</span></div>
<div class="line">         <span class="comment">// Increase the start address for the next call of this function</span></div>
<div class="line">         <span class="comment">// </span></div>
<div class="line">         ulAddrStartS = ulAddrStartS + uwSizeV;</div>
<div class="line"> </div>
<div class="line">         <span class="comment">//-----------------------------------------------------------------------------------</span></div>
<div class="line">         <span class="comment">// lock flash</span></div>
<div class="line">         <span class="comment">//</span></div>
<div class="line">         <a class="code hl_function" href="mc__flash_8h.html#a13a481e202b71b890ccbff63a5e29343">McFlashLock</a>();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">//-------------------------------------------------------------------------------------------</span></div>
<div class="line">      <span class="comment">// store operation finished</span></div>
<div class="line">      <span class="comment">//</span></div>
<div class="line">      ubCblMgrBufferStoreG = 0;</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="ttc" id="acbl__mgr_8h_html_a4beb62dc5018b06f558366cd4f418608"><div class="ttname"><a href="cbl__mgr_8h.html#a4beb62dc5018b06f558366cd4f418608">CblMgrBufferStore</a></div><div class="ttdeci">void CblMgrBufferStore(uint8_t ubProgNumV, uint8_t *pubBufferV, uint16_t uwSizeV)</div></div>
<div class="ttc" id="amc__flash_8h_html_a9e97798abc12ae92c41839f24064d103"><div class="ttname"><a href="mc__flash_8h.html#a9e97798abc12ae92c41839f24064d103">McFlashWrite</a></div><div class="ttdeci">Status_tv McFlashWrite(uint32_t ulAddressV, void *pvdDataV, uint32_t ulSizeV)</div><div class="ttdoc">Write data.</div></div>
</div><!-- fragment --> <h1>Finalize Flash Programming</h1>
<p>The function <a class="el" href="cbl__mgr_8h.html#a5274f1da62f4601141b4fa924383aa5c">CblMgrFlashFinalize()</a> is called by the CANopen Bootloader after all data has written to the target system. The following pseudo code has to be adopted to the target system.</p>
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="cbl__mgr_8h.html#a5274f1da62f4601141b4fa924383aa5c">CblMgrFlashFinalize</a>(uint8_t ubProgNumV, uint32_t ulSizeV)</div>
<div class="line">{</div>
<div class="line">   uint8_t *   pubMemStartT;     <span class="comment">// memory start address</span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// The function is called after the download is completed. We store the infomration about the</span></div>
<div class="line">   <span class="comment">// program size and the program CRC inside the IAP block.</span></div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">   <span class="comment">//---------------------------------------------------------------------------------------------------</span></div>
<div class="line">   <span class="comment">// If the flash status is not equal to eCBL_FLASH_STATUS_PROGRESS something went wrong</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <span class="keywordflow">if</span> (<a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] != <a class="code hl_enumvalue" href="cbl__mgr_8h.html#ae90447d48ead6e3826aa66905b52e4e0addb624cb27e10c8a9dad093ff3050848">eCBL_FLASH_STATUS_PROGRESS</a>)</div>
<div class="line">   {</div>
<div class="line">      <a class="code hl_variable" href="cbl__objs_8h.html#ab0a69221ce606d106cacb872def6d0df">aulIdx1F56_SoftIdentG</a>[ubProgNumV] = 0;</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">   {</div>
<div class="line">      <span class="comment">//-------------------------------------------------------------------------------------------</span></div>
<div class="line">      <span class="comment">// build checksum over stored data</span></div>
<div class="line">      <span class="comment">//</span></div>
<div class="line">      pubMemStartT = (uint8_t *)(<a class="code hl_define" href="cbl__conf_8h.html#a01ecd75e4d11f5e4a10233a5d211bb42">CBL_APP_START_ADDR</a>);</div>
<div class="line">      <a class="code hl_variable" href="cbl__objs_8h.html#ab0a69221ce606d106cacb872def6d0df">aulIdx1F56_SoftIdentG</a>[ubProgNumV]   = <a class="code hl_function" href="cbl__mgr_8h.html#a3a1ccacea0a540760029d71796c0efa6">CblMgrBufferCrc</a>(pubMemStartT, ulSizeV);</div>
<div class="line">      <a class="code hl_variable" href="cbl__objs_8h.html#a321cba23fceb635734f97a3f4bce73e2">aulIdx1F57_FlashStatusG</a>[ubProgNumV] = <a class="code hl_enumvalue" href="cbl__mgr_8h.html#ae90447d48ead6e3826aa66905b52e4e0acd2d6d9d69727113d77900486bbd06de">eCBL_FLASH_STATUS_OK</a>;</div>
<div class="line"> </div>
<div class="line">   }</div>
<div class="line">} </div>
<div class="line"> </div>
<div class="ttc" id="acbl__mgr_8h_html_a3a1ccacea0a540760029d71796c0efa6"><div class="ttname"><a href="cbl__mgr_8h.html#a3a1ccacea0a540760029d71796c0efa6">CblMgrBufferCrc</a></div><div class="ttdeci">uint32_t CblMgrBufferCrc(uint8_t *pubMemStartV, uint32_t ulSizeV)</div></div>
<div class="ttc" id="acbl__mgr_8h_html_a5274f1da62f4601141b4fa924383aa5c"><div class="ttname"><a href="cbl__mgr_8h.html#a5274f1da62f4601141b4fa924383aa5c">CblMgrFlashFinalize</a></div><div class="ttdeci">void CblMgrFlashFinalize(uint8_t ubProgNumV, uint32_t ulSizeV)</div></div>
<div class="ttc" id="acbl__mgr_8h_html_ae90447d48ead6e3826aa66905b52e4e0acd2d6d9d69727113d77900486bbd06de"><div class="ttname"><a href="cbl__mgr_8h.html#ae90447d48ead6e3826aa66905b52e4e0acd2d6d9d69727113d77900486bbd06de">eCBL_FLASH_STATUS_OK</a></div><div class="ttdeci">@ eCBL_FLASH_STATUS_OK</div><div class="ttdef"><b>Definition:</b> cbl_mgr.h:75</div></div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer"><a href="https://www.microcontrol.net">&copy; MicroControl GmbH &amp; Co. KG</a> Fri Jul 28 2023 </li>
  </ul>
</div>
</body>
</html>
